!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n(e.HAWS=e.HAWS||{})}(this,function(e){"use strict";function n(e){return{type:"auth",api_password:e}}function t(){return{type:"get_states"}}function s(){return{type:"get_config"}}function r(){return{type:"get_services"}}function i(){return{type:"get_panels"}}function o(e,n,t){var s={type:"call_service",domain:e,service:n};return t&&(s.service_data=t),s}function c(e){var n={type:"subscribe_events"};return e&&(n.event_type=e),n}function u(e){return{type:"unsubscribe_events",subscription:e}}function a(){return{type:"ping"}}function d(e,n){return{type:"result",success:!1,error:{code:e,message:n}}}function f(e){return e.result}function v(e,n){var t=new k(e,n);return t.connect()}function p(e,n){return new Promise(function(t,s){function r(e){var t=Object.assign({},o.core,{components:o.core.components.concat(e.data.component)});o=Object.assign({},o,{core:t}),n(o)}function i(e){var t,s,r=e.data,i=r.domain,c=r.service,u=Object.assign({},o.services[i]||{},(t={},t[c]={description:"",fields:{}},t));o=Object.assign({},o,{services:Object.assign({},o.services,(s={},s[i]=u,s))}),n(o)}var o=null;Promise.all([e.getConfig(),e.getPanels(),e.getServices(),e.subscribeEvents(r,"component_loaded"),e.subscribeEvents(i,"service_registered")]).then(function(e){var s=e[0],r=e[1],i=e[2],c=e[3],u=e[4];o={core:s,panels:r,services:i},n(o),t(function(){c(),u()})},function(){return s()})})}function m(e){for(var n={},t=0;t<e.length;t++){var s=e[t];n[s.entity_id]=s}return n}function h(e,n){var t=Object.assign({},e);return t[n.entity_id]=n,t}function l(e,n){var t=Object.assign({},e);return delete t[n],t}function b(e,n){return new Promise(function(t,s){function r(e){var t=e.data,s=t.entity_id,r=t.new_state;i=r?h(i,r):l(i,s),n(i)}var i=null,o=e.subscribeEvents(r,"state_changed"),c=e.getStates().then(function(e){i=m(e),n(i)});Promise.all([o,c]).then(function(e){var n=e[0];return t(n)},function(){return s()})})}var g=1,y=2,_=3,k=function(e,n){this.url=e,this.options=n||{},this.commandId=1,this.commands={},this.connectionTries=0,this.eventListeners={},this.closeRequested=!1};k.prototype.addEventListener=function(e,n){var t=this.eventListeners[e];t||(t=this.eventListeners[e]=[]),t.push(n)},k.prototype.fireEvent=function(e){var n=this;(this.eventListeners[e]||[]).forEach(function(e){return e(n)})},k.prototype.connect=function(){var e=this;return new Promise(function(t,s){var r=e.commands;Object.keys(r).forEach(function(e){var n=r[e];n.reject&&n.reject(d(_,"Connection lost"))});var i=!1;e.connectionTries+=1,e.socket=new WebSocket(e.url),e.socket.addEventListener("open",function(){e.connectionTries=0}),e.socket.addEventListener("message",function(o){var c=JSON.parse(o.data);switch(c.type){case"event":e.commands[c.id].eventCallback(c.event);break;case"result":c.success?e.commands[c.id].resolve(c):e.commands[c.id].reject(c.error),delete e.commands[c.id];break;case"pong":break;case"auth_required":e.sendMessage(n(e.options.authToken));break;case"auth_invalid":s(y),i=!0;break;case"auth_ok":t(e),e.fireEvent("ready"),e.commandId=1,e.commands={},Object.keys(r).forEach(function(n){var t=r[n];t.eventType&&e.subscribeEvents(t.eventCallback,t.eventType).then(function(e){t.unsubscribe=e})})}}),e.socket.addEventListener("close",function(){if(!i&&!e.closeRequested){0===e.connectionTries?e.fireEvent("disconnected"):s(g);var n=1e3*Math.min(e.connectionTries,5);setTimeout(function(){return e.connect()},n)}})})},k.prototype.close=function(){this.closeRequested=!0,this.socket.close()},k.prototype.getStates=function(){return this.sendMessagePromise(t()).then(f)},k.prototype.getServices=function(){return this.sendMessagePromise(r()).then(f)},k.prototype.getPanels=function(){return this.sendMessagePromise(i()).then(f)},k.prototype.getConfig=function(){return this.sendMessagePromise(s()).then(f)},k.prototype.callService=function(e,n,t){return this.sendMessagePromise(o(e,n,t))},k.prototype.subscribeEvents=function(e,n){var t=this;return this.sendMessagePromise(c(n)).then(function(s){var r={eventCallback:e,eventType:n,unsubscribe:function(){return t.sendMessagePromise(u(s.id)).then(function(){delete t.commands[s.id]})}};return t.commands[s.id]=r,function(){return r.unsubscribe()}})},k.prototype.ping=function(){return this.sendMessagePromise(a())},k.prototype.sendMessage=function(e){this.socket.send(JSON.stringify(e))},k.prototype.sendMessagePromise=function(e){var n=this;return new Promise(function(t,s){n.commandId+=1;var r=n.commandId;e.id=r,n.commands[r]={resolve:t,reject:s},n.sendMessage(e)})},e.ERR_CANNOT_CONNECT=g,e.ERR_INVALID_AUTH=y,e.createConnection=v,e.subscribeConfig=p,e.subscribeEntities=b,Object.defineProperty(e,"__esModule",{value:!0})});
